trigger:
  branches:
    include:
      - main

stages:
  - stage: BuildAndPush
    displayName: 'Build and Push Docker Image to AWS ECR'
    jobs:
      - job: Build
        displayName: 'Build and Push Job'
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          - group: 'AWS_ECR_Credentials'  # Ensure this group exists and is correctly populated
          - name: IMAGE_TAG
            value: $(Build.BuildId)
          - name: AWS_ACCESS_KEY_ID
            value: $(AWS_ACCESS_KEY_ID)  # Directly reference from variable group
          - name: AWS_SECRET_ACCESS_KEY
            value: $(AWS_SECRET_ACCESS_KEY)  # Directly reference from variable group
          - name: AWS_REGION
            value: $(AWS_REGION)  # Directly reference from variable group

        steps:
          - checkout: self

          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                echo "Setting up AWS CLI..."
                echo "AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID"
                echo "AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY"
                echo "AWS_REGION: $AWS_REGION"
                aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                aws configure set default.region $AWS_REGION
                aws sts get-caller-identity  # Verify credentials
            displayName: 'AWS CLI Setup and Verification'
